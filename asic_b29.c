#include <stdlib.h>
#include <assert.h>
#include <fcntl.h>
#include <limits.h>
#include <unistd.h>
#include <stdbool.h>

#include "logging.h"
#include "miner.h"
#include "util.h"

#include "spi-context.h"
#include "asic_b29.h"
#include "asic_b29_cmd.h"
#include "asic_b29_clock.h"
#include "asic_b29_gpio.h"

#include "dm_temp_ctrl.h"

//#define MAGIC_NUM  100 
#define MUL_COEF 1.23

extern b29_reg_ctrl_t s_reg_ctrl;

int nReadVolTimes = 0;
int nVolTotal = 0;

static const uint8_t default_reg[PLL_LV_NUM][REG_LENGTH] = 
{
    {0x02, 0x50, 0x40, 0x52, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 30MHz
    {0x02, 0x54, 0x40, 0x52, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 32MHz
    {0x02, 0x58, 0x40, 0x52, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 33MHz
    {0x02, 0x5c, 0x40, 0x52, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 35MHz
    {0x02, 0x60, 0x40, 0x52, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 36MHz
    {0x02, 0x64, 0x40, 0x52, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 38MHz
    {0x02, 0x34, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 39MHz
    {0x02, 0x36, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 41MHz
    {0x02, 0x38, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 42MHz
    {0x02, 0x3a, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 44MHz
    {0x02, 0x3c, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 45MHz
    {0x02, 0x3e, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 47MHz
    {0x02, 0x40, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 48MHz
    {0x02, 0x42, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 50MHz
    {0x02, 0x44, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 51MHz
    {0x02, 0x46, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 53MHz
    {0x02, 0x48, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 54MHz
    {0x02, 0x4a, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 56MHz
    {0x02, 0x4c, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 57MHz
    {0x02, 0x4e, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 59MHz
    {0x02, 0x50, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 60MHz
    {0x02, 0x52, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 62MHz
    {0x02, 0x54, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 63MHz
    {0x02, 0x56, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 65MHz
    {0x02, 0x58, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 66MHz
    {0x02, 0x5a, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 68MHz
    {0x02, 0x5c, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 69MHz
    {0x02, 0x5e, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 71MHz
    {0x02, 0x60, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 72MHz
    {0x02, 0x62, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 74MHz
    {0x02, 0x64, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 75MHz
    {0x02, 0x66, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 77MHz
    {0x02, 0x68, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 78MHz
    {0x02, 0x6a, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 80MHz
    {0x02, 0x6c, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 81MHz
    {0x02, 0x6e, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 83MHz
    {0x02, 0x70, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 84MHz
    {0x02, 0x72, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 86MHz
    {0x02, 0x74, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 87MHz
    {0x02, 0x76, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 89MHz
    {0x02, 0x78, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 90MHz
    {0x02, 0x7a, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 92MHz
    {0x02, 0x7c, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 93MHz
    {0x02, 0x7e, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 95MHz
    {0x02, 0x80, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 96MHz
    {0x02, 0x82, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 98MHz
    {0x02, 0x84, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 99MHz
    {0x02, 0x86, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 101MHz
    {0x02, 0x88, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 102MHz
    {0x02, 0x8a, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 104MHz
    {0x02, 0x8c, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 105MHz
    {0x02, 0x8e, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 107MHz
    {0x02, 0x90, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 108MHz
    {0x02, 0x92, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 110MHz
    {0x02, 0x94, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 111MHz
    {0x02, 0x96, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 113MHz
    {0x02, 0x98, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 114MHz
    {0x02, 0x9a, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 116MHz
    {0x02, 0x9c, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 117MHz
    {0x02, 0x9e, 0x40, 0x42, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 119MHz
    {0x02, 0x50, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 120MHz
    {0x02, 0x51, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 122MHz
    {0x02, 0x52, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 123MHz
    {0x02, 0x53, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 125MHz
    {0x02, 0x54, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 126MHz
    {0x02, 0x55, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 128MHz
    {0x02, 0x56, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 129MHz
    {0x02, 0x57, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 131MHz
    {0x02, 0x58, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 132MHz
    {0x02, 0x59, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 134MHz
    {0x02, 0x5a, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 135MHz
    {0x02, 0x5b, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 137MHz
    {0x02, 0x5c, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 138MHz
    {0x02, 0x5d, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 140MHz
    {0x02, 0x5e, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 141MHz
    {0x02, 0x5f, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 143MHz
    {0x02, 0x60, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 144MHz
    {0x02, 0x61, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 146MHz
    {0x02, 0x62, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 147MHz
    {0x02, 0x63, 0x40, 0x32, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 149MHz
    {0x02, 0x32, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 150MHz
    {0x02, 0x33, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 153MHz
    {0x02, 0x34, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 156MHz
    {0x02, 0x35, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 159MHz
    {0x02, 0x36, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 162MHz
    {0x02, 0x37, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 165MHz
    {0x02, 0x38, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 168MHz
    {0x02, 0x39, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 171MHz
    {0x02, 0x3a, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 174MHz
    {0x02, 0x3b, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 177MHz
    {0x02, 0x3c, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 180MHz
    {0x02, 0x3d, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 183MHz
    {0x02, 0x3e, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 186MHz
    {0x02, 0x3f, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 189MHz
    {0x02, 0x40, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 192MHz
    {0x02, 0x41, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 195MHz
    {0x02, 0x42, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 198MHz
    {0x02, 0x43, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 201MHz
    {0x02, 0x44, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 204MHz
    {0x02, 0x45, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 207MHz
    {0x02, 0x46, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 210MHz
    {0x02, 0x47, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 213MHz
    {0x02, 0x48, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 216MHz
    {0x02, 0x49, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 219MHz
    {0x02, 0x4a, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 222MHz
    {0x02, 0x4b, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 225MHz
    {0x02, 0x4c, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 228MHz
    {0x02, 0x4d, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 231MHz
    {0x02, 0x4e, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 234MHz
    {0x02, 0x4f, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 237MHz
    {0x04, 0xa0, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 240MHz
    {0x04, 0xa1, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 242MHz
    {0x04, 0xa2, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 243MHz
    {0x04, 0xa3, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 245MHz
    {0x04, 0xa4, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 246MHz
    {0x04, 0xa5, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 248MHz
    {0x04, 0xa6, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 249MHz
    {0x04, 0xa7, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 251MHz
    {0x04, 0xa8, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 252MHz
    {0x04, 0xa9, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 254MHz
    {0x04, 0xaa, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 255MHz
    {0x04, 0xab, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 257MHz
    {0x04, 0xac, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 258MHz
    {0x04, 0xad, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 260MHz
    {0x04, 0xae, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 261MHz
    {0x04, 0xaf, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 263MHz
    {0x04, 0xb0, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 264MHz
    {0x04, 0xb1, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 266MHz
    {0x04, 0xb2, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 267MHz
    {0x04, 0xb3, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 269MHz
    {0x04, 0xb4, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 270MHz
    {0x04, 0xb5, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 272MHz
    {0x04, 0xb6, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 273MHz
    {0x04, 0xb7, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 275MHz
    {0x04, 0xb8, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 276MHz
    {0x04, 0xb9, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 278MHz
    {0x04, 0xba, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 279MHz
    {0x04, 0xbb, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 281MHz
    {0x04, 0xbc, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 282MHz
    {0x04, 0xbd, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 284MHz
    {0x04, 0xbe, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 285MHz
    {0x04, 0xbf, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 287MHz
    {0x04, 0xc0, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 288MHz
    {0x04, 0xc1, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 290MHz
    {0x04, 0xc2, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 291MHz
    {0x04, 0xc3, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 293MHz
    {0x04, 0xc4, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 294MHz
    {0x04, 0xc5, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 296MHz
    {0x04, 0xc6, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 297MHz
    {0x04, 0xc7, 0x40, 0x22, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 299MHz
    {0x04, 0x64, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 300MHz
    {0x04, 0x65, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 303MHz
    {0x04, 0x66, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 306MHz
    {0x04, 0x67, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 309MHz
    {0x04, 0x68, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 312MHz
    {0x04, 0x69, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 315MHz
    {0x04, 0x6a, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 318MHz
    {0x04, 0x6b, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 321MHz
    {0x04, 0x6c, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 324MHz
    {0x04, 0x6d, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 327MHz
    {0x04, 0x6e, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 330MHz
    {0x04, 0x6f, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 333MHz
    {0x04, 0x70, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 336MHz
    {0x04, 0x71, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 339MHz
    {0x04, 0x72, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 342MHz
    {0x04, 0x73, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 345MHz
    {0x04, 0x74, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 348MHz
    {0x04, 0x75, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 351MHz
    {0x04, 0x76, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 354MHz
    {0x04, 0x77, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 357MHz
    {0x04, 0x78, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 360MHz
    {0x04, 0x79, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 363MHz
    {0x04, 0x7a, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 366MHz
    {0x04, 0x7b, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 369MHz
    {0x04, 0x7c, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 372MHz
    {0x04, 0x7d, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 375MHz
    {0x04, 0x7e, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 378MHz
    {0x04, 0x7f, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 381MHz
    {0x04, 0x80, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 384MHz
    {0x04, 0x81, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 387MHz
    {0x04, 0x82, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 390MHz
    {0x04, 0x83, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 393MHz
    {0x04, 0x84, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 396MHz
    {0x04, 0x85, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 399MHz
    {0x04, 0x86, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 402MHz
    {0x04, 0x87, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 405MHz
    {0x04, 0x88, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 408MHz
    {0x04, 0x89, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 411MHz
    {0x04, 0x8a, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 414MHz
    {0x04, 0x8b, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 417MHz
    {0x04, 0x8c, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 420MHz
    {0x04, 0x8d, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 423MHz
    {0x04, 0x8e, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 426MHz
    {0x04, 0x8f, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 429MHz
    {0x04, 0x90, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 432MHz
    {0x04, 0x91, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 435MHz
    {0x04, 0x92, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 438MHz
    {0x04, 0x93, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 441MHz
    {0x04, 0x94, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 444MHz
    {0x04, 0x95, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 447MHz
    {0x04, 0x96, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 450MHz
    {0x04, 0x97, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 453MHz
    {0x04, 0x98, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 456MHz
    {0x04, 0x99, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 459MHz
    {0x04, 0x9a, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 462MHz
    {0x04, 0x9b, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 465MHz
    {0x04, 0x9c, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 468MHz
    {0x04, 0x9d, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 471MHz
    {0x04, 0x9e, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 474MHz
    {0x04, 0x9f, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 477MHz
    {0x04, 0xa0, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 480MHz
    {0x04, 0xa1, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 483MHz
    {0x04, 0xa2, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 486MHz
    {0x04, 0xa3, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 489MHz
    {0x04, 0xa4, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 492MHz
    {0x04, 0xa5, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 495MHz
    {0x04, 0xa6, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 498MHz
    {0x04, 0xa7, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 501MHz
    {0x04, 0xa8, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 504MHz
    {0x04, 0xa9, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 507MHz
    {0x04, 0xaa, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 510MHz
    {0x04, 0xab, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 513MHz
    {0x04, 0xac, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 516MHz
    {0x04, 0xad, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 519MHz
    {0x04, 0xae, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 522MHz
    {0x04, 0xaf, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 525MHz
    {0x04, 0xb0, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 528MHz
    {0x04, 0xb1, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 531MHz
    {0x04, 0xb2, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 534MHz
    {0x04, 0xb3, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 537MHz
    {0x04, 0xb4, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 540MHz
    {0x04, 0xb5, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 543MHz
    {0x04, 0xb6, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 546MHz
    {0x04, 0xb7, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x24, 0x00, 0x00},    // 549MHz
    {0x04, 0xb8, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 552MHz
    {0x04, 0xb9, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 555MHz
    {0x04, 0xba, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 558MHz
    {0x04, 0xbb, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 561MHz
    {0x04, 0xbc, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 564MHz
    {0x04, 0xbd, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 567MHz
    {0x04, 0xbe, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 570MHz
    {0x04, 0xbf, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 573MHz
    {0x04, 0xc0, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 576MHz
    {0x04, 0xc1, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 579MHz
    {0x04, 0xc2, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 582MHz
    {0x04, 0xc3, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 585MHz
    {0x04, 0xc4, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 588MHz
    {0x04, 0xc5, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 591MHz
    {0x04, 0xc6, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 594MHz
    {0x04, 0xc7, 0x40, 0x12, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 597MHz
    {0x04, 0x64, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 600MHz
    {0x04, 0x65, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 606MHz
    {0x04, 0x66, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 612MHz
    {0x04, 0x67, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 618MHz
    {0x04, 0x68, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 624MHz
    {0x04, 0x69, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 630MHz
    {0x04, 0x6a, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 636MHz
    {0x04, 0x6b, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 642MHz
    {0x04, 0x6c, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 648MHz
    {0x04, 0x6d, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 654MHz
    {0x04, 0x6e, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 660MHz
    {0x04, 0x6f, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 666MHz
    {0x04, 0x70, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 672MHz
    {0x04, 0x71, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 678MHz
    {0x04, 0x72, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 684MHz
    {0x04, 0x73, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 690MHz
    {0x04, 0x74, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 696MHz
    {0x04, 0x75, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 702MHz
    {0x04, 0x76, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 708MHz
    {0x04, 0x77, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 714MHz
    {0x04, 0x78, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 720MHz
    {0x04, 0x79, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 726MHz
    {0x04, 0x7a, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 732MHz
    {0x04, 0x7b, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 738MHz
    {0x04, 0x7c, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 744MHz
    {0x04, 0x7d, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 750MHz
    {0x04, 0x7e, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 756MHz
    {0x04, 0x7f, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 762MHz
    {0x04, 0x80, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 768MHz
    {0x04, 0x81, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 774MHz
    {0x04, 0x82, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 780MHz
    {0x04, 0x83, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 786MHz
    {0x04, 0x84, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 792MHz
    {0x04, 0x85, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 798MHz
    {0x04, 0x86, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 804MHz
    {0x04, 0x87, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 810MHz
    {0x04, 0x88, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 816MHz
    {0x04, 0x89, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 822MHz
    {0x04, 0x8a, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 828MHz
    {0x04, 0x8b, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 834MHz
    {0x04, 0x8c, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 840MHz
    {0x04, 0x8d, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 846MHz
    {0x04, 0x8e, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 852MHz
    {0x04, 0x8f, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 858MHz
    {0x04, 0x90, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 864MHz
    {0x04, 0x91, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 870MHz
    {0x04, 0x92, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 876MHz
    {0x04, 0x93, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 882MHz
    {0x04, 0x94, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 888MHz
    {0x04, 0x95, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 894MHz
    {0x04, 0x96, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 900MHz
    {0x04, 0x97, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 906MHz
    {0x04, 0x98, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 912MHz
    {0x04, 0x99, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 918MHz
    {0x04, 0x9a, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 924MHz
    {0x04, 0x9b, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 930MHz
    {0x04, 0x9c, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 936MHz
    {0x04, 0x9d, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 942MHz
    {0x04, 0x9e, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 948MHz
    {0x04, 0x9f, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 954MHz
    {0x04, 0xa0, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 960MHz
    {0x04, 0xa1, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 966MHz
    {0x04, 0xa2, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 972MHz
    {0x04, 0xa3, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 978MHz
    {0x04, 0xa4, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 984MHz
    {0x04, 0xa5, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 990MHz
    {0x04, 0xa6, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 996MHz
    {0x04, 0xa7, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1002MHz
    {0x04, 0xa8, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1008MHz
    {0x04, 0xa9, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1014MHz
    {0x04, 0xaa, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1020MHz
    {0x04, 0xab, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1026MHz
    {0x04, 0xac, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1032MHz
    {0x04, 0xad, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1038MHz
    {0x04, 0xae, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1044MHz
    {0x04, 0xaf, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1050MHz
    {0x04, 0xb0, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1056MHz
    {0x04, 0xb1, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1062MHz
    {0x04, 0xb2, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1068MHz
    {0x04, 0xb3, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1074MHz
    {0x04, 0xb4, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1080MHz
    {0x04, 0xb5, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1086MHz
    {0x04, 0xb6, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1092MHz
    {0x04, 0xb7, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1098MHz
    {0x04, 0xb8, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1104MHz
    {0x04, 0xb9, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1110MHz
    {0x04, 0xba, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1116MHz
    {0x04, 0xbb, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1122MHz
    {0x04, 0xbc, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1128MHz
    {0x04, 0xbd, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1134MHz
    {0x04, 0xbe, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1140MHz
    {0x04, 0xbf, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1146MHz
    {0x04, 0xc0, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1152MHz
    {0x04, 0xc1, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1158MHz
    {0x04, 0xc2, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1164MHz
    {0x04, 0xc3, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1170MHz
    {0x04, 0xc4, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1176MHz
    {0x04, 0xc5, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1182MHz
    {0x04, 0xc6, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1188MHz
    {0x04, 0xc7, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1194MHz
    {0x02, 0x64, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1200MHz
    {0x02, 0x65, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1212MHz
    {0x02, 0x66, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1224MHz
    {0x02, 0x67, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1236MHz
    {0x02, 0x68, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1248MHz
    {0x02, 0x69, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1260MHz
    {0x02, 0x6a, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1272MHz
    {0x02, 0x6b, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00},    // 1284MHz
    {0x02, 0x6c, 0x40, 0x02, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x20, 0x00, 0x00}     // 1296MHz
};

static const uint8_t difficult_Tbl[7][32] = {
	 /*128*/
	 {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00},
	 /*256*/
	 {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00},
	 /*512*/
	 {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00},
	 /*1024*/
	 {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00},
	 /*2048*/
	 {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00},
	 /*4096*/
	 {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00},
	 /*8192*/
	 {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00},
};

void create_job(uint8_t *job, uint8_t chip_id, uint8_t job_id, struct work *work)
{
	int i;
	uint16_t crc;
	uint8_t tmp_buf[226];

	double sdiff = work->device_diff;
	char* target = NULL;

#if 0
   printf("work data: \r\n");
         for(i = 0; i < 180; i++)
         {
             printf("0x%02x  ", work->data[i]);
             if((i % 10) == 9)
             {
                 printf("\r\n");
             }
         }
         printf("\r\n");


   printf("work target: \r\n");
            for(i = 0; i < 32; i++)
            {
                printf("0x%02x  ", work->target[i]);
                if((i % 8) == 7)
                {
                    printf("\r\n");
                }
            }
            printf("\r\n");
#endif

    job[0] = (job_id << 4) | CMD_WRITE_JOB;
    job[1] = chip_id;

    memcpy(job+2,(uint8_t *)work->data,180);

	
	if (sdiff>4095)
		target = difficult_Tbl[5];
	else if (sdiff>2047)		
		target = difficult_Tbl[4];
	else if (sdiff>1023)
		target = difficult_Tbl[3];
	else if (sdiff > 511)
		target = difficult_Tbl[2];
	else if (sdiff > 255)
		target = difficult_Tbl[1];
	else
		target = difficult_Tbl[0];
//	swab256(job + 182, work->target);
	swab256(job + 182, target);

    job[214] = 0xff;
    job[215] = 0xff;
    job[216] = 0xff;
    job[217] = 0xff;

    for(i = 0; i < 109; i++)
    {
        tmp_buf[(2 * i) + 1] = job[(2 * i) + 0];
        tmp_buf[(2 * i) + 0] = job[(2 * i) + 1];
    }
    crc = CRC16_2(tmp_buf, 218);
    job[218] = (uint8_t)((crc >> 8) & 0xff);
    job[219] = (uint8_t)((crc >> 0) & 0xff);

    return;
}


#define COOLDOWN_MS         (30 * 1000)
#define DISABLE_CHIP_FAIL_THRESHOLD 3
#define LEAST_CORE_ONE_CHAIN    100
#define RESET_CHAIN_CNT 2
/********** disable / re-enable related section (temporary for testing) */
int get_current_ms(void)
{
    cgtimer_t ct;
    cgtimer_time(&ct);
    return cgtimer_to_ms(&ct);
}

bool is_chip_disabled(struct A1_chain *a1, uint8_t chip_id)
{
    struct A1_chip *chip = &a1->chips[chip_id - 1];
    return chip->disabled || chip->cooldown_begin != 0;
}

/* check and disable chip, remember time */
void disable_chip(struct A1_chain *a1, uint8_t chip_id)
{
    printf("disable chip\n");
//    flush_spi(a1);    // hub - duanhao
    struct A1_chip *chip = &a1->chips[chip_id - 1];
    int cid = a1->chain_id;
    if (is_chip_disabled(a1, chip_id)) {
        applog(LOG_NOTICE, "%d: chip %d already disabled",
               cid, chip_id);
        return;
    }
    applog(LOG_NOTICE, "%d: temporary disabling chip %d", cid, chip_id);
    chip->cooldown_begin = get_current_ms();
}

/* check if disabled chips can be re-enabled */
void check_disabled_chips(struct A1_chain *a1)
{
    int i;
    int cid = a1->chain_id;
    uint8_t reg[REG_LENGTH];

    for (i = 0; i < a1->num_active_chips; i++) 
    {
        int chip_id = i + 1;
        struct A1_chip *chip = &a1->chips[i];
        if (!is_chip_disabled(a1, chip_id))
            continue;
        /* do not re-enable fully disabled chips */
        if (chip->disabled)
            continue;
        if (chip->cooldown_begin + COOLDOWN_MS > get_current_ms())
            continue;
        
        if (!mcompat_cmd_read_register(a1->chain_id, chip_id, reg, REG_LENGTH)) 
        {
            chip->fail_count++;
            applog(LOG_NOTICE, "%d: chip %d not yet working - %d", cid, chip_id, chip->fail_count);

            if (chip->fail_count > DISABLE_CHIP_FAIL_THRESHOLD) 
            {
                applog(LOG_NOTICE, "%d: completely disabling chip %d at %d",
                       cid, chip_id, chip->fail_count);
                chip->disabled = true;
                a1->num_cores -= chip->num_cores;
            }
            else
            {
                /* restart cooldown period */
                chip->cooldown_begin = get_current_ms();
            }
        }
        else
        {
            applog(LOG_NOTICE, "%d: chip %d is working again", cid, chip_id);
            chip->cooldown_begin = 0;
            chip->fail_count = 0;
            chip->fail_reset = 0;
        }
    }
    
#if 1       // TODO: differ BIN1 / BIN2
    //if the core in chain least than 100, reinit this chain
    if(mcompat_get_plug(a1->chain_id) == 0)
    {
        if(a1->num_cores <= LEAST_CORE_ONE_CHAIN)
        {
            applog(LOG_WARNING, "****core:%d*start to reset the chain:%d******************", a1->num_cores, cid);

            mcompat_chain_power_down_all();
        }
    } else {
         applog(LOG_WARNING, "chain %d not insert,change all gpio to zero****", cid);

         mcompat_chain_power_down_all();
    }
#endif             
}



bool set_work(struct A1_chain *a1, uint8_t chip_id, struct work *work, uint8_t queue_states)
{
    int cid = a1->chain_id;
    struct A1_chip *chip = &a1->chips[chip_id - 1];
    bool retval = false;

    int job_id = chip->last_queued_id + 1;
    
    //printf("%d: queuing chip %d with job_id %d, state=0x%02x,last_queued:0x%x,addr:0x%x,0x%x\n", cid, chip_id, job_id, queue_states,chip->last_queued_id,chip->work[chip->last_queued_id-1],chip->work[chip->last_queued_id]);
    if (job_id == (queue_states & 0x0f) || job_id == (queue_states >> 4))
    {
        applog(LOG_NOTICE, "%d: job overlap: %d, 0x%02x", cid, job_id, queue_states);
    }

    if (chip->work[chip->last_queued_id] != NULL) 
    {
        //printf("set work 500\n");
        work_completed(a1->cgpu, chip->work[chip->last_queued_id]);
        chip->work[chip->last_queued_id] = NULL;    
        retval = true;
    }
    
    uint8_t jobdata[JOB_LENGTH] = { 0 };
    create_job(jobdata, chip_id, job_id, work);
    if (!mcompat_cmd_write_job(a1->chain_id, chip_id, jobdata, JOB_LENGTH)) 
    {
        /* give back work */
        work_completed(a1->cgpu, work);
        applog(LOG_ERR, "%d: failed to set work for chip %d.%d", cid, chip_id, job_id);
    } 
    else 
    {
        chip->work[chip->last_queued_id] = work;
        chip->last_queued_id++;
        chip->last_queued_id &= 3;
    }
    return retval;
}


bool get_nonce(struct A1_chain *a1, uint8_t *nonce, uint8_t *chip_id, uint8_t *job_id)
{
    uint8_t buffer[NONCE_LEN + 2];
    memset(buffer, 0, sizeof(buffer));

#ifdef USE_AUTONONCE
	if (mcompat_cmd_read_nonce(a1->chain_id, buffer, NONCE_LEN))
#else
	if (mcompat_cmd_read_result(a1->chain_id, CMD_ADDR_BROADCAST, buffer, NONCE_LEN))
#endif
    {
        *job_id = buffer[0] >> 4;
        *chip_id = buffer[1];

        if(buffer[2] || buffer[3] || buffer[4] || buffer[5])
        { 
          memcpy(nonce, buffer+2, 4);
        //applog(LOG_ERR, "Nonce: %02x %02x %02x %02x", nonce[0], nonce[1], nonce[2], nonce[3]);
         return true;
        }else{
        return false;
        }
    }
    
    return false;
}

bool abort_work(struct A1_chain *a1)
{

    applog(LOG_INFO,"abort work");

    return true;
}

bool check_chip(struct A1_chain *a1, int cid)
{
    uint8_t buffer[REG_LENGTH];
    int chip_id = cid + 1;

    memset(buffer, 0, sizeof(buffer));
    if (!mcompat_cmd_read_register(a1->chain_id, chip_id, buffer, REG_LENGTH)) {
        applog(LOG_NOTICE, "%d: Failed to read register for chip %d -> disabling", a1->chain_id, chip_id);
        a1->chips[cid].num_cores = 0;
        a1->chips[cid].disabled = 1;
        return false;
    }

    a1->chips[cid].num_cores = buffer[11];
    a1->num_cores += a1->chips[cid].num_cores;
    //applog(LOG_WARNING, "%d: Found chip %d with %d active cores",cid, chip_id, a1->chips[cid].num_cores);

    //keep ASIC register value
    memcpy(a1->chips[cid].reg, buffer, REG_LENGTH);
    a1->chips[cid].temp= 0x000003ff & ((buffer[7]<<8) | buffer[8]);

    if (a1->chips[cid].num_cores < BROKEN_CHIP_THRESHOLD){
        applog(LOG_NOTICE, "%d: broken chip %d with %d active cores (threshold = %d)",a1->chain_id,chip_id,a1->chips[cid].num_cores,BROKEN_CHIP_THRESHOLD);
        a1->chips[cid].disabled = true;
        a1->num_cores -= a1->chips[cid].num_cores;

        return false;
    }

    if (a1->chips[cid].num_cores < WEAK_CHIP_THRESHOLD) {
        applog(LOG_NOTICE, "%d: weak chip %d with %d active cores (threshold = %d)",a1->chain_id,chip_id, a1->chips[cid].num_cores, WEAK_CHIP_THRESHOLD);
        return false;
    }
    a1->chips[cid].pll = a1->pll;
    return true;
}

int prechain_detect(struct A1_chain *a1, int idxpll, int lastidx)
{
    //uint8_t buffer[64];
    int cid = a1->chain_id;
    uint8_t temp_reg[REG_LENGTH];
    int i,nCount = 0;
    
     a1->base_pll = idxpll;
    //usleep(500000);
    
    for(i=lastidx; i<idxpll+1; i++)
    {
    	// update temperature for all chains once two second
		dm_tempctrl_update_temp(0xff);

        nCount = 0;
        memcpy(temp_reg, default_reg[i], REG_LENGTH);
        
         while(!mcompat_cmd_write_register(a1->chain_id, ADDR_BROADCAST, temp_reg, REG_LENGTH))
         {
               usleep(200000);
               nCount++;
               if(nCount > 5) 
               {
                  applog(LOG_ERR, "set default PLL fail");
                  return -1;
                }
          }
       
           usleep(20000);
           a1->pll = i;
      }
        
        applog(LOG_WARNING, "chain %d set PLL Lv.%d success", cid, i);

        usleep(500000);
    return 0;
}

/*
 * BIST_START works only once after HW reset, on subsequent calls it
 * returns 0 as number of chips.
 */
int chain_detect(struct A1_chain *a1)
{
    uint8_t n_chips = mcompat_cmd_bist_start(a1->chain_id, ADDR_BROADCAST);

    if(unlikely(n_chips == 0) || unlikely(n_chips == 0xff)){
        return -1;
    }

    a1->num_chips = n_chips; 

    return a1->num_chips;
}

//add 0922
void b29_configure_tvsensor(struct A1_chain *a1, int chip_id,bool is_tsensor)
{
    //int i;
    unsigned char tmp_reg[REG_LENGTH] = {0};
    unsigned char src_reg[REG_LENGTH] = {0};
    unsigned char reg[REG_LENGTH] = {0};

    mcompat_cmd_read_register(a1->chain_id, 0x01, reg, REG_LENGTH);
    memcpy(src_reg, reg, REG_LENGTH);
    mcompat_cmd_write_register(a1->chain_id, chip_id, src_reg, REG_LENGTH);
    usleep(200);

    if(is_tsensor)
    { //configure for tsensor
        //Step1: wait for clock stable
        //Step2: low the tsdac rst_n and release rst_n after 4 SysClk
        //hexdump("write reg", reg, REG_LENGTH);
        reg[7] = (src_reg[7]&0x7f);
        memcpy(tmp_reg, reg, REG_LENGTH);
        //hexdump("write reg", tmp_reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);
        reg[7] = (src_reg[7]|0x80);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);

        //Step3: Config tsadc_clk(default match)
        //Step4: low tsadc_tsen_pd
        //Step5: high tsadc_ana_reg_2
        reg[6] = (src_reg[6]|0x04);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);

        //Step6: high tsadc_en
        reg[7] = (src_reg[7]|0x20);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);

        //Step7: tsadc_ana_reg_9 = 0;tsadc_ana_reg_8  = 0
        reg[5] = (src_reg[5]&0xfc);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);

        //Step8: tsadc_ana_reg_7 = 1;tsadc_ana_reg_1 = 0
        reg[6] = (src_reg[6]&0x7d);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);
    }
    else
    { //configure for vsensor
        //Step1: wait for clock stable
        //Step2: low the tsdac rst_n and release rst_n after 4 SysClk
        // hexdump("write reg", reg, REG_LENGTH);
        reg[7] = (src_reg[7]&0x7f);
        memcpy(tmp_reg, reg, REG_LENGTH);
        // hexdump("write reg", tmp_reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);
        reg[7] = (src_reg[7]|0x80);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);

        //Step3: Config tsadc_clk(default match)
        //Step4: low tsadc_tsen_pd
        //Step5: high tsadc_ana_reg_2
        reg[6] = (src_reg[6]|0x04);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);

        //Step6: high tsadc_en
        reg[7] = (src_reg[7]|0x20);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);

        //Step7: tsadc_ana_reg_9 = 0;tsadc_ana_reg_8  = 0
        reg[5] = ((src_reg[5]|0x01)&0xfd);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);

        //Step8: tsadc_ana_reg_7 = 1;tsadc_ana_reg_1 = 0
        reg[6] = ((src_reg[6]|0x02)&0x7f);
        memcpy(tmp_reg, reg, REG_LENGTH);
        mcompat_cmd_write_register(a1->chain_id,chip_id,tmp_reg, REG_LENGTH);
        usleep(200);
    }
}

int b29_get_voltage_stats(struct A1_chain *a1, b29_reg_ctrl_t *s_reg_ctrl)
{
    int i = 0;
    int cid = a1->chain_id;
    s_reg_ctrl->highest_vol[cid] = s_reg_ctrl->stat_val[cid][0];
    s_reg_ctrl->lowest_vol[cid] = s_reg_ctrl->stat_val[cid][0];
    int total_vol = s_reg_ctrl->stat_val[cid][0];

    if((a1->num_active_chips < 1) || (a1 == NULL))
        return -1;

    for (i = 1; i < a1->num_active_chips; i++)
    {
        if(s_reg_ctrl->highest_vol[cid] < s_reg_ctrl->stat_val[cid][i])
            s_reg_ctrl->highest_vol[cid] = s_reg_ctrl->stat_val[cid][i];

        if(s_reg_ctrl->lowest_vol[cid] > s_reg_ctrl->stat_val[cid][i])
            s_reg_ctrl->lowest_vol[cid] = s_reg_ctrl->stat_val[cid][i];

        total_vol += s_reg_ctrl->stat_val[cid][i];
    }

    s_reg_ctrl->average_vol[cid] = total_vol / a1->num_active_chips;

    return 0;
}

bool b29_check_voltage(struct A1_chain *a1, int chip_id, b29_reg_ctrl_t *s_reg_ctrl)
{
  
    uint8_t reg[REG_LENGTH];
    memset(reg, 0, REG_LENGTH);
  
    if (!mcompat_cmd_read_register(a1->chain_id, chip_id, reg, REG_LENGTH)) {
        applog(LOG_NOTICE, "%d: Failed to read register for ""chip %d -> disabling", a1->chain_id, chip_id);
        a1->chips[chip_id].num_cores = 0;
        a1->chips[chip_id].disabled = 1;
        return false;
    } else {
        usleep(2000);

        /* update temp database */
        uint32_t rd_v = 0;
        rd_v = 0x000003ff & ((reg[7] << 8) | reg[8]);
        float tmp_v = (float)(rd_v * MUL_COEF)/1024;
        a1->chips[chip_id-1].nVol = tmp_v *1000; 
        s_reg_ctrl->stat_val[a1->chain_id][chip_id-1] = a1->chips[chip_id-1].nVol;
        //s_reg_ctrl->stat_cnt[a1->chain_id][chip_id-1]++;
        
        //applog(LOG_WARNING,"read tmp %f/%d form chain %d,chip %d h:%f,l:%f,av:%f,cnt:%d\n",tmp_v,rd_v,a1->chain_id, chip_id,s_reg_ctrl->highest_vol[a1->chain_id][chip_id-1],s_reg_ctrl->lowest_vol[a1->chain_id][chip_id-1],s_reg_ctrl->avarge_vol[a1->chain_id][chip_id-1],s_reg_ctrl->stat_cnt[a1->chain_id][chip_id-1]);
        nReadVolTimes++;
                    
        if((tmp_v > CHIP_VOL_MAX) || (tmp_v < CHIP_VOL_MIN)){
            
            applog(LOG_ERR,"tmp_v = %f,nVolTotal = %d",tmp_v,nVolTotal);
            nVolTotal++;
        }
        //applog(LOG_ERR,"nReadVolTimes = %d,nVolTotal = %d",nReadVolTimes,nVolTotal);
        
        if(nVolTotal >= 3){
            applog(LOG_ERR,"Notice chain %d chip %d maybe has some promble in voltage %d",a1->chain_id,chip_id,a1->chips[chip_id-1].nVol);
            nVolTotal = 0;
            nReadVolTimes = 0;
            //mcompat_chain_power_down(a1->chain_id);
           // early_quit(1,"Notice chain %d maybe has some promble in voltage %d",a1->chain_id,tmp_v);
        }
        
    }

    return true;
}


hardware_version_e b29_get_hwver(void)
{
    FILE* fd;
    char buffer[64] = {0};
    hardware_version_e version;
    
    fd = fopen(B29_HARDWARE_VERSION_FILE, "r");    
    if(fd == NULL)
    {               
        applog(LOG_ERR, "Open hwver File Failed !");
        return -1;
    }

    fread(buffer, 8, 1, fd);
    fclose(fd);

    if(strstr(buffer, "G9") != NULL) {
        version = HARDWARE_VERSION_G9;
        applog(LOG_INFO, "hardware version is G9");
    }else if(strstr(buffer, "G19") != 0) {
        version = HARDWARE_VERSION_G19;
        applog(LOG_INFO, "hardware version is G19");
    }else {
        version = 0;
        applog(LOG_ERR, "unknown hardware version !!!");
    }

    return version;
}


b29_type_e b29_get_miner_type(void)
{
    FILE* fd;
    char buffer[64] = {0};
    b29_type_e miner_type;
    
    fd = fopen(B29_MINER_TYPE_FILE, "r");  
    if(fd == NULL)
    {               
        applog(LOG_ERR, "Open type File Failed!");
        return -1;
    }

    fread(buffer, 8, 1, fd);
    fclose(fd);

    if(strstr(buffer, "T1") != NULL) {
        miner_type = B29_TYPE_A5;
        applog(LOG_INFO, "miner type is T1");
    }else if(strstr(buffer, "T2") != NULL) {
        miner_type = B29_TYPE_A6;
        applog(LOG_INFO, "miner type is T2");
    }else if(strstr(buffer, "T3") != NULL) {
        miner_type = B29_TYPE_A7;
        applog(LOG_INFO, "miner type is T3");
    }else if(strstr(buffer, "T4") != NULL) {
        miner_type = B29_TYPE_A8;
        applog(LOG_INFO, "miner type is T4");
    }else {
        miner_type = 0;
        applog(LOG_INFO, "unknown miner type !!!");
    }

    return miner_type;
}


